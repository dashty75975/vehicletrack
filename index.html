<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vehicle Tracking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7f7f9;
      --text:#1f2328;
      --card:#ffffff;
      --muted:#e6e8eb;
      --primary:#0d6efd;
    }
    [data-theme="dark"]{
      --bg:#0f1115;
      --text:#e6eaf0;
      --card:#151922;
      --muted:#242a35;
      --primary:#539bf5;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--muted);display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 12px;font-weight:700}
    .brand{display:flex;align-items:center;gap:8px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--primary)}
    .controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid var(--muted);background:var(--card);color:var(--text);padding:6px 10px;border-radius:8px;cursor:pointer}
    .chip:hover{background:var(--bg)}
    .theme-control{display:flex;align-items:center;gap:6px;border:1px solid var(--muted);padding:6px 8px;border-radius:10px;background:var(--card)}
    .theme-control select, .theme-control input[type="color"]{border:none;background:transparent;color:var(--text)}
    #vehicleBar{display:flex;justify-content:center;gap:10px;padding:8px;background:var(--card);border-bottom:1px solid var(--muted)}
    #vehicleBar button{padding:8px 14px;border-radius:8px;border:1px solid var(--muted);background:var(--card);cursor:pointer;font-size:14px}
    #vehicleBar button.active{background:var(--primary);color:#fff}
    #map{width:100%;height:calc(100vh - 210px)}
    .panel{max-width:520px;margin:18px auto;padding:18px;background:var(--card);border:1px solid var(--muted);border-radius:14px}
    .panel h2{margin:0 0 10px}
    .row{display:flex;gap:10px}
    .row>div{flex:1}
    input,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--muted);background:var(--bg);color:var(--text)}
    .btn{width:100%;padding:12px;border:none;border-radius:10px;cursor:pointer;background:var(--primary);color:white;font-weight:700}
    .btn.secondary{background:var(--card);color:var(--text);border:1px solid var(--muted)}
    .btn.warn{background:#dc3545}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid var(--muted);padding:8px;text-align:left}
    th{background:var(--bg)}
    .hidden{display:none}
    #myLocationBtn{position:absolute;top:220px;left:10px;z-index:5;background:var(--card);border:1px solid var(--muted);padding:8px 10px;border-radius:10px;cursor:pointer}
  </style>
</head>
<body data-theme="light">
  <header>
    <div class="brand"><span class="dot"></span><span>Vehicle Tracking</span></div>
    <div class="controls">
      <div class="theme-control">
        <label for="themeMode">Theme:</label>
        <select id="themeMode" onchange="onThemeModeChange(this.value)">
          <option value="light" selected>Light</option>
          <option value="dark">Dark</option>
        </select>
        <input id="themeColor" type="color" value="#0d6efd" onchange="onThemeColor(this.value)" />
      </div>
      <button class="chip" onclick="showSection('mapSection')">Map</button>
      <button class="chip" onclick="showSection('registerSection')">Driver Register</button>
      <button class="chip" onclick="showSection('driverLoginSection')">Driver Login</button>
      <button class="chip" onclick="showSection('adminLoginSection')">Admin</button>
    </div>
  </header>

  <div id="vehicleBar"></div>
  <section id="mapSection"><div id="map"></div><button id="myLocationBtn" onclick="centerOnUser()">📍 My Location</button></section>

  <section id="registerSection" class="hidden">
    <div class="panel">
      <h2>Driver Registration</h2>
      <div class="row"><div><input id="regName" placeholder="Full Name"></div><div><input id="regEmail" type="email" placeholder="Email"></div></div>
      <div class="row"><div><input id="regPhone" placeholder="Phone Number"></div><div><input id="regLicense" placeholder="Driver License Number"></div></div>
      <div class="row"><div><input id="regPlate" placeholder="Vehicle Plate"></div>
        <div><select id="regType"><option value="Bus">🚌 Bus</option><option value="Taxi">🚖 Taxi</option><option value="Van">🚐 Van</option><option value="TukTuk">🛺 Tuk-Tuk</option></select></div>
      </div>
      <div class="row"><div><input id="routeFrom" placeholder="Route From"></div><div><input id="routeTo" placeholder="Route To"></div></div>
      <div class="row"><div><input id="taxiNumber" placeholder="Taxi Number"></div></div>
      <input id="regPass" type="password" placeholder="Password">
      <button class="btn" onclick="registerDriver()">Register</button>
    </div>
  </section>

  <section id="driverLoginSection" class="hidden"><div class="panel"><h2>Driver Login</h2><input id="driverEmail" type="email" placeholder="Email"><input id="driverPass" type="password" placeholder="Password"><button class="btn" onclick="driverLogin()">Login</button></div></section>

  <section id="driverPanelSection" class="hidden"><div class="panel"><h2>Driver Panel</h2><button class="btn" onclick="driverToggleOnline()">Go <span id="driverStatusText">Online</span></button><button class="btn secondary" onclick="logoutToMap()">Logout</button></div></section>

  <section id="adminLoginSection" class="hidden"><div class="panel"><h2>Admin Login</h2><input id="adminEmail" type="email" placeholder="Email"><input id="adminPass" type="password" placeholder="Password"><button class="btn" onclick="adminLogin()">Login</button></div></section>

  <section id="adminPanelSection" class="hidden"><div class="panel"><h2>Admin Dashboard</h2><table id="driversTable"><thead><tr><th>Name</th><th>Type</th><th>Status</th><th>Online</th></tr></thead><tbody></tbody></table><button class="btn secondary" onclick="logoutToMap()">Logout</button></div></section>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase.createClient(
      "https://mrjukodibztebnsytepu.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yanVrb2RpYnp0ZWJuc3l0ZXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMjEzNzgsImV4cCI6MjA3MTg5NzM3OH0.ljNARMpJbPRVcfPV2QV2NnFIblt25vJ_V3k7g-RJ6u4"
    );

    let map, meMarker=null, currentDriver=null;
    const markersByDriverId = new Map();
    let filterType = "All";

    function onThemeModeChange(mode){document.body.setAttribute('data-theme', mode==='dark'?'dark':'light');}
    function onThemeColor(hex){document.documentElement.style.setProperty('--primary', hex);}
    function showSection(id){document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));document.getElementById(id).classList.remove('hidden');}
    function logoutToMap(){currentDriver=null;showSection('mapSection');}

    function renderVehicleBar(){
      const bar=document.getElementById('vehicleBar');
      const types=["All","Taxi","Bus","Van","TukTuk"];
      bar.innerHTML='';
      types.forEach(t=>{
        const btn=document.createElement('button');
        btn.textContent=t;
        if(t===filterType)btn.classList.add('active');
        btn.onclick=()=>{filterType=t;renderVehicleBar();fetchDrivers();};
        bar.appendChild(btn);
      });
    }

    function initMap(){map=new google.maps.Map(document.getElementById('map'),{center:{lat:36.1911,lng:44.0090},zoom:13});centerOnUser(true);fetchDrivers();subscribeRealtime();}

    function centerOnUser(initial=false){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(pos=>{const p={lat:pos.coords.latitude,lng:pos.coords.longitude};map.setCenter(p);if(!meMarker){meMarker=new google.maps.Marker({position:p,map,icon:'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'});}else{meMarker.setPosition(p);}if(initial)map.setZoom(14);});}}

    async function fetchDrivers(){let { data, error } = await supabase.from('drivers').select('*');if(error){console.error(error);return;}if(filterType!=="All"){data=data.filter(d=>d.type===filterType);}renderDrivers(data);renderMarkers(data);}

    function renderDrivers(data){const tbody=document.querySelector('#driversTable tbody');tbody.innerHTML='';data.forEach(d=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${d.name}</td><td>${d.type}</td><td>${d.status}</td><td>${d.online?'Online':'Offline'}</td>`;tbody.appendChild(tr);});}

    function renderMarkers(drivers){
      markersByDriverId.forEach((marker,id)=>{
        if(!drivers.find(d=>d.id===id)){
          marker.setMap(null);
          markersByDriverId.delete(id);
        }
      });
      drivers.forEach(d=>{
        if(!d.lat||!d.lng)return;
        let marker=markersByDriverId.get(d.id);
        if(!marker){
          marker=new google.maps.Marker({map:null});
          markersByDriverId.set(d.id,marker);
          const infowin=new google.maps.InfoWindow();
          marker.addListener('click',()=>{
            infowin.setContent(`
              <div style="font-size:14px">
                <b>${d.type}</b> - ${d.name}<br>
                📞 ${d.phone||''}<br>
                🚘 Plate: ${d.plate||''} ${d.taxi_number||''}<br>
                ${d.route_from&&d.route_to?`🧭 ${d.route_from} → ${d.route_to}`:''}
              </div>`);
            infowin.open({anchor:marker,map});
          });
        }
        marker.setPosition({lat:d.lat,lng:d.lng});
        marker.setTitle(`${d.type} - ${d.name}`);
        marker.setIcon(getMarkerIconForType(d.type));
        marker.setMap(d.online?map:null);
      });
    }

    function getMarkerIconForType(type){
      const urls={Bus:'https://maps.google.com/mapfiles/ms/icons/green-dot.png',Taxi:'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png',Van:'https://maps.google.com/mapfiles/ms/icons/purple-dot.png',TukTuk:'https://maps.google.com/mapfiles/ms/icons/orange-dot.png'};
      return {url:urls[type]||'https://maps.google.com/mapfiles/ms/icons/red-dot.png'};
    }

    async function registerDriver(){
      const d={name:val('regName'),email:val('regEmail'),pass:val('regPass'),phone:val('regPhone'),license:val('regLicense'),plate:val('regPlate'),type:val('regType'),taxi_number:val('taxiNumber'),route_from:val('routeFrom'),route_to:val('routeTo'),status:(val('regType')==='Taxi'?'Pending':'Approved'),online:false};
      if(navigator.geolocation){navigator.geolocation.getCurrentPosition(pos=>{d.lat=pos.coords.latitude;d.lng=pos.coords.longitude;supabase.from('drivers').insert([d]);});}else{await supabase.from('drivers').insert([d]);}
      alert('Registered!');fetchDrivers();showSection('mapSection');
    }

    async function driverLogin(){const email=val('driverEmail'),pass=val('driverPass');let { data,error }=await supabase.from('drivers').select('*').eq('email',email).eq('pass',pass).maybeSingle();if(error||!data){alert('Invalid');return;}if(data.type==='Taxi'&&data.status!=='Approved'){alert('Taxi pending approval');return;}currentDriver=data;document.getElementById('driverStatusText').innerText=data.online?'Offline':'Online';showSection('driverPanelSection');}

    async function driverToggleOnline(){if(!currentDriver)return;currentDriver.online=!currentDriver.online;if(navigator.geolocation){navigator.geolocation.getCurrentPosition(pos=>{currentDriver.lat=pos.coords.latitude;currentDriver.lng=pos.coords.longitude;supabase.from('drivers').update({online:currentDriver.online,lat:currentDriver.lat,lng:currentDriver.lng}).eq('id',currentDriver.id);});}else{await supabase.from('drivers').update({online:currentDriver.online}).eq('id',currentDriver.id);}document.getElementById('driverStatusText').innerText=currentDriver.online?'Offline':'Online';fetchDrivers();}

    function adminLogin(){if(val('adminEmail')==='admin@example.com'&&val('adminPass')==='password'){showSection('adminPanelSection');fetchDrivers();}else alert('Invalid admin');}

    function val(id){return document.getElementById(id).value.trim();}

    function subscribeRealtime(){
      supabase.channel('drivers-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'drivers' }, payload => {
          console.log('Realtime update:', payload);
          fetchDrivers();
        })
        .subscribe();
    }

    document.addEventListener('DOMContentLoaded',()=>{renderVehicleBar();});
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDplHGkSwtUjhWC-Zy6DNfesRH4IdWAKDM&callback=initMap"></script>
</body>
</html>
